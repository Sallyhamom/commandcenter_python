<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AMR Stations Control</title>
<style>
  :root{
    --bg:#0f1724;
    --panel:rgba(12,18,28,0.9);
    --muted:#94a3b8;
    --accent:#2355ab;
    --glass: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.06);
    --text:#e6eef6;
    --shadow: 0 8px 30px rgba(2,6,23,0.6);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  :root.light{
    --bg:#f3f4f6;
    --panel:#ffffff;
    --muted:#475569;
    --accent:#0ea5a4;
    --glass: rgba(2,6,23,0.03);
    --border: rgba(2,6,23,0.06);
    --text:#0f1724;
    --shadow: 0 10px 30px rgba(2,6,23,0.08);
  }

  html,body {height:100%;margin:0;background:var(--bg);color:var(--text);overflow:hidden}
  .app {height:100vh;display:flex;flex-direction:column}

  /* Top bar */
  .topbar{
    height:50px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 18px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    box-shadow:var(--shadow);
    border-bottom:1px solid var(--border);
    z-index:20;
    position:relative
  }
  .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:1px}
  .brand .logo{height:80px;padding:0px 0px;border-radius:6px;color:rgb(165, 164, 196);font-weight:700}
  .top-actions{display:flex;align-items:center;gap:10px}
  .btn{
    background:var(--panel);
    border:1px solid var(--border);
    padding:8px 10px;
    border-radius:8px;
    color:var(--text);
    cursor:pointer;
    backdrop-filter: blur(6px);
    position:relative;
    z-index:20;
    font-size:13px
  }
  .btn.ghost{background:transparent}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#3b82f6);color:white;border:none}
  .btn.danger{background:#b91c1c;color:white;border:none}
  .btn.small{padding:4px 8px;font-size:12px}

  /* layout */
  .workspace{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:12px;
    gap:12px;
    box-sizing:border-box
  }

  /* TOP: map + video */
  .top-row{
    flex:1;
    display:flex;
    gap:12px;
    min-height:0;
  }

  .amr-map-area,
  .amr-video-area{
    flex:2;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.06);
    background:radial-gradient(circle at top, rgba(15,23,42,0.6), rgba(15,23,42,1));
    position:relative;
    overflow:hidden;
    box-shadow:var(--shadow);
  }

  .amr-map-inner{
    position:absolute;
    inset:0;
    overflow:hidden;
  }

  #stationMapImg {
    width: 100%;
    height: 100%;
    object-fit: cover;   /* üî• THIS IS THE KEY */
    display: block;
  }

  #amr-marker {
    position: absolute;
    width: 26px;
    height: 26px;
    background: rgba(239, 68, 68, 0.9);
    border: 2px solid rgba(248, 250, 252, 0.95);
    border-radius: 6px;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  /* üî∫ direction arrow (robot nose) */
  #amr-marker::after {
    content: "";
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 10px solid rgba(248, 250, 252, 0.95);
  }

  .station-joystick-overlay{
    position:absolute;
    right:12px;
    top:12px;
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:8px;
    z-index:10;
  }

  .pose-btn{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    font-size:12px;
    cursor:pointer;
    background:rgba(15,23,42,0.9);
    color:white;
  }

  .pose-btn.on{
    background:#16a34a;
    color:white;
    border-color:#15803d;
  }

  .dpad-toggle{
    padding:4px 10px;
    border-radius:999px;
    border:none;
    font-size:12px;
    cursor:pointer;
    background:#b91c1c;
    color:white;
  }
  .dpad-toggle.on{
    background:#16a34a;
  }

  .dpad-grid{
    display:grid;
    grid-template-columns:repeat(3,40px);
    grid-template-rows:repeat(3,40px);
    gap:4px;
    padding:8px;
    border-radius:10px;
    /*border:1px solid var(--border);*/
  }
  .dpad-btn{
    border-radius:8px;
    border:none;
    background:#1e293b;
    color:#e5e7eb;
    font-size:16px;
    cursor:pointer;
    box-shadow:0 2px 8px rgba(0,0,0,0.35);
  }
  .dpad-btn.disabled{
    background:#111827;
    color:#4b5563;
    cursor:default;
    box-shadow:none;
  }
  .dpad-btn.stop{
    background:#b91c1c;
    color:white;
    font-weight:bold;
  }

  /* VIDEO AREA */
  .amr-video-inner{
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
  }
  .video-header{
    padding:8px 10px;
    font-size:13px;
    font-weight:600;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:rgba(15,23,42,0.9);
    border-bottom:1px solid var(--border);
    z-index:2;
  }
  .video-body{
    flex:1;
    position:relative;
    overflow:hidden;
  }
  #zedVideoFrame{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    background:#020617;
  }

  /* BOTTOM ROW: stations left, actions right */
  .bottom-row{
    flex:0 0 auto;
    display:flex;
    gap:12px;
    min-height:200px;
  }

  .station-panel{
    background:var(--panel);
    border-radius:10px;
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .station-panel.left{
    flex:2;
  }
  .station-panel.right{
    flex:1.2;
  }

  .station-panel-header{
    padding:10px 14px;
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .station-panel-header-title{
    font-size:14px;
    font-weight:700;
  }
  .station-panel-header-sub{
    font-size:11px;
    color:var(--muted);
  }

  .station-panel-body{
    padding:12px 14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    overflow:auto;
  }

  .input-row{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .input-row input{
    flex:1;
    padding:6px 8px;
    border-radius:6px;
    border:1px solid var(--border);
    background:rgba(15,23,42,0.7);
    color:var(--text);
    font-size:13px;
  }

  .stations-help{
    font-size:12px;
    color:var(--muted);
  }

  .station-actions-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:4px;
  }

  .stations-grid-wrapper{
    flex:1;
    border-radius:8px;
    border:1px solid var(--border);
    background:rgba(15,23,42,0.8);
    padding:10px;
    overflow:auto;
  }

  .stations-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  .station-card{
    width:150px;
    min-height:90px;
    border-radius:8px;
    border:1px solid var(--border);
    background:rgba(15,23,42,0.85);
    padding:8px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    cursor:pointer;
    transition:transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease, background 0.1s ease;
  }
  .station-card:hover{
    transform:translateY(-1px);
    box-shadow:0 6px 14px rgba(0,0,0,0.7);
  }
  .station-card.selected{
    border-color:#22c55e;
    background:rgba(34,197,94,0.15);
  }

  .station-name{
    font-size:14px;
    font-weight:600;
    margin-bottom:4px;
  }
  .station-meta{
    font-size:11px;
    color:var(--muted);
    margin-bottom:6px;
  }

  .station-card-buttons{
    display:flex;
    gap:6px;
  }
  .station-card-buttons button{
    flex:1;
    padding:4px 0;
    font-size:12px;
    border-radius:999px;
    border:none;
    cursor:pointer;
  }
  .station-go{
    background:#16a34a;
    color:white;
  }
  .station-del{
    background:#b91c1c;
    color:white;
  }

  .station-footer-line{
    font-size:11px;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:4px;
  }

  /* bottom bar */
  .bottombar{
    height:30px;
    background:linear-gradient(180deg, rgba(0,0,0,0.06), transparent);
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:6px 12px;
    border-top:1px solid var(--border);
    z-index:20;
    position:relative
  }
  .status-strip{display:flex;gap:12px;align-items:center}
  .stat{
    background:var(--panel);
    padding:8px 10px;
    border-radius:8px;
    border:1px solid var(--border);
    min-width:140px;
    text-align:center;
    font-size:12px
  }

  .status-pill {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  .status-ok  { background:#16381c; color:#4caf50; }
  .status-bad { background:#3a1616; color:#f44336; }

  @media (max-width: 960px){
    .workspace{
      flex-direction:column;
    }
    .top-row{
      flex-direction:column;
    }
    .amr-map-area,.amr-video-area{
      flex:none;
      height:35%;
    }
    .bottom-row{
      flex-direction:column;
    }
    .station-panel.left,
    .station-panel.right{
      flex:none;
      height:auto;
    }
  }
  .pose-dpad-row {
    display: flex;
    gap: 8px;
  }
  /* ===============================
     NEW LEFT / RIGHT LAYOUT
  ================================ */

  .main-row {
    flex: 1;
    display: flex;
    gap: 12px;
    min-height: 0;
  }

  .left-panel {
    flex: 2.2;
    position: relative;
    display: flex;
    min-width: 0;
  }

  .right-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-width: 320px;
    overflow: hidden;
  }

  /* Map fills left */
  .amr-map-area {
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  /* ===============================
     VIDEO PIP (inside map)
  ================================ */

  .map-video-pip {
    position: absolute;
    right: 12px;
    bottom: 12px;
    width: 320px;
    height: 180px;
    background: #020617;
    border-radius: 10px;
    border: 1px solid var(--border);
    box-shadow: 0 10px 30px rgba(0,0,0,0.7);
    overflow: hidden;
    z-index: 20;
  }

  .map-video-pip .video-header {
    height: 28px;
    background: rgba(15,23,42,0.9);
    color: var(--muted);
    font-size: 12px;
    display: flex;
    align-items: center;
    padding: 0 8px;
  }

  .map-video-pip img {
    width: 100%;
    height: calc(100% - 28px);
    object-fit: cover;
    display: block;
  }
  /* ===============================
     MAP PAN + ZOOM
  ================================ */

  .amr-map-inner {
    cursor: grab;
    overflow: hidden;
  }

  .amr-map-inner.dragging {
    cursor: grabbing;
  }

  .map-transform {
    transform-origin: 0 0;
    will-change: transform;
  }
  /* ===============================
     SWAPPABLE VIEW ROLES
  ================================ */

  .main-view {
    position: absolute;
    inset: 0;
    z-index: 1;
  }

  .pip-view {
    position: absolute;
    width: 40%;
    height: 38%;
    right: 12px;
    bottom: 12px;
    z-index: 20;
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(0,0,0,0.7);
  }

  .btn-outline-danger {
    background: transparent;
    color: #ef4444;
    border: 1px solid #ef4444;
  }

  .btn-outline-danger:hover {
    background: #ef4444;
    color: #ffffff;
  }

  .btn-outline-danger:active {
    background: #dc2626;
    border-color: #dc2626;
  }

  .btn-outline-success {
    background: transparent;
    color: #22c55e;                 /* green-500 */
    border: 1px solid #22c55e;
  }

  .btn-outline-success:hover {
    background: #22c55e;
    color: #ffffff;
  }

  .btn-outline-success:active {
    background: #16a34a;            /* green-600 */
    border-color: #16a34a;
  }

  .btn-outline-success:disabled,
  .btn-outline-success.disabled {
    color: #4ade80;
    border-color: #4ade80;
    opacity: 0.6;
    cursor: not-allowed;
  }

  #mapTransform {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }

</style>
</head>
<body>

<div class="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="./static/arlogowithrvmt.png" height="100%"/>
      </div>
      <div style="line-height:1; padding-top: 8px;">
        <div style="font-size:25px">AMR CONTROL</div>
        <div style="font-size:18px;color:var(--muted)">Stations & Navigation</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn ghost" id="themeToggle">üåô</button>
      <button class="btn primary" onclick="location.href='/uav-cc'">UAV</button>
    </div>
  </div>

  <!-- WORKSPACE -->
  <div class="workspace">

    <div class="main-row">

      <!-- LEFT: MAP + VIDEO -->
      <div class="left-panel">

        <!-- MAP -->
        <div class="amr-map-area" id="mapArea">
          <div id="mapView" class="main-view">
            <div class="amr-map-inner" id="map-container">
              <div id="mapTransform" class="map-transform">
                <img id="stationMapImg">
                <!--<div id="amr-marker"></div>-->
              </div>
            </div>
          </div>

          <!-- VIDEO -->
          <div id="videoView" class="pip-view">
            <div class="video-header">ZED Camera</div>
            <img id="zedVideoFrame">
          </div>

          <!-- DPAD + POSE -->
          <div class="station-joystick-overlay">
            <div class="pose-dpad-row">
              <button class="pose-btn" id="poseBtn">2D Pose: OFF</button>
              <button class="dpad-toggle" id="dpadToggle">DPAD: OFF</button>
            </div>
            <div class="dpad-grid" id="dpadGrid">
              <div></div>
              <button class="dpad-btn" id="dpadUp">‚Üë</button>
              <div></div>
              <button class="dpad-btn" id="dpadLeft">‚Üê</button>
              <button class="dpad-btn stop" id="dpadStop">‚ñ†</button>
              <button class="dpad-btn" id="dpadRight">‚Üí</button>
              <div></div>
              <button class="dpad-btn" id="dpadDown">‚Üì</button>
              <div></div>
            </div>
          </div>

          <div class="station-odom" id="stationOdom">
            Waiting for odometry...
          </div>
        </div>

      </div>

      <!-- RIGHT: DETAILS -->
      <div class="right-panel">

        <!-- RIGHT: STATION PANEL -->
        <div class="station-panel">
          <div class="station-panel-header">
            <div>
              <div class="station-panel-header-title">Navigation Controls</div>
              <div class="station-panel-header-sub">Save stations and send goals to AMR</div>
            </div>
            <button class="btn danger small" id="emergencyStopBtn">STOP</button>
          </div>

          <div class="station-panel-body">
            <div>
              <div class="input-row">
                <input type="text" id="stationNameInput" placeholder="Enter station name">
                <button class="btn btn-outline-success small" id="saveStationBtn">Save</button>
              </div>
              <div class="stations-help">
                The AMR‚Äôs current pose will be stored as this station on the robot.
              </div>
            </div>

            <div class="station-actions-top">
              <div style="font-size:13px;font-weight:600;">Stations</div>
              <button class="btn btn-outline-danger small" id="cancelGoalBtn">Cancel Navigation</button>
            </div>
            <div class="stations-help">
              Click a card, then <strong>GO</strong> to start navigation. Use <strong>2D Pose</strong> above the map for initial pose.
            </div>

            <div class="stations-grid-wrapper">
              <div class="stations-grid" id="stationsGrid">
                <!-- station cards will be injected here -->
              </div>
            </div>

            <div class="station-footer-line">
              <span id="stationCountLabel">0 stations loaded</span>
             <!-- <span id="wsStatusLabel">WS: connecting‚Ä¶</span>-->
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>


  <!-- BOTTOM BAR -->
  <div class="bottombar">
    <div class="status-strip">
      <div class="stat">Robot: <strong id="robotName">AMR-01</strong></div>
      <div class="stat">Mode: <strong id="robotMode">Manual / Station Nav</strong></div>
      <div class="stat"><span id="amrLinkStatus" class="status-pill status-bad">IPC: Disconnected</span></div>
    </div>
    <div style="font-size:13px;color:var(--muted)">User: Admin</div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    let amrMarker = null;
    // THEME TOGGLE
    const themeToggle = document.getElementById("themeToggle");
    themeToggle.addEventListener("click", () => {
      document.documentElement.classList.toggle("light");
      themeToggle.textContent =
        document.documentElement.classList.contains("light") ? "‚òÄÔ∏è" : "üåô";
      document.getElementsByClassName("logo")[0].children[0].src =
        document.documentElement.classList.contains('light')
          ? "/static/arrobotlogowithrvmt_light.png"
          : "/static/arlogowithrvmt.png";
      document.getElementsByClassName("logo")[0].children[0].height =
        document.documentElement.classList.contains('light') ? 90 : 80;
    });

    // ======== WEBSOCKET SETUP ========
    const wsUrl =
      (location.protocol === "https:" ? "wss://" : "ws://") +
      location.host +
      "/ws/amr_stations";

    let socket = null;
    let reconnectTimer = null;
    const wsStatusLabel = document.getElementById("wsStatusLabel");
    const amrLinkStatus = document.getElementById("amrLinkStatus");

    const stationsGrid = document.getElementById("stationsGrid");
    const stationCountLabel = document.getElementById("stationCountLabel");
    const stationOdom = document.getElementById("stationOdom");

    const stationMapImg = document.getElementById("stationMapImg");
    const mapContainer = document.getElementById("map-container");

    const zedVideoFrame = document.getElementById("zedVideoFrame");

    let stationMap = {};
    let selectedStationName = null;

    /*function setWsStatus(text, ok) {
      wsStatusLabel.textContent = text;
      if (ok) {
        amrLinkStatus.textContent = "IPC: Connected";
        amrLinkStatus.classList.remove("status-bad");
        amrLinkStatus.classList.add("status-ok");
      } else {
        amrLinkStatus.textContent = "IPC: Disconnected";
        amrLinkStatus.classList.remove("status-ok");
        amrLinkStatus.classList.add("status-bad");
      }
    }*/

    // ======== MAP / AMR MARKER CONFIG ========
    const originX = 0.0;
    const originY = 0.0;
    const resolution = 0.05; // adjust to your map

    let mapPixelWidth = 0;
    let mapPixelHeight = 0;

    stationMapImg.addEventListener("load", () => {
      mapPixelWidth = stationMapImg.naturalWidth;
      mapPixelHeight = stationMapImg.naturalHeight;
    });

    function worldToPixel(x, y) {
      const px = (x - originX) / resolution;
      const py = (y - originY) / resolution;
      const pyFlipped = mapPixelHeight - py;
      return { px, py: pyFlipped };
    }

    function ensureAmrMarker() {
      if (amrMarker) return;

      amrMarker = document.createElement("div");
      amrMarker.id = "amr-marker";
      mapTransform.appendChild(amrMarker);
    }

    function updateMarker(x, y, theta) {
      if (!mapPixelWidth || !mapPixelHeight) return;

      // Create marker only on first valid pose
      ensureAmrMarker();

      const { px, py } = worldToPixel(x, y);
      const containerWidth = mapContainer.clientWidth;
      const containerHeight = mapContainer.clientHeight;

      const scaleX = containerWidth / mapPixelWidth;
      const scaleY = containerHeight / mapPixelHeight;

      const sx = px * scaleX;
      const sy = py * scaleY;

      amrMarker.style.left = `${sx}px`;
      amrMarker.style.top = `${sy}px`;

      if (theta !== undefined && theta !== null) {
        const deg = theta * 180 / Math.PI;
        amrMarker.style.transform = `translate(-50%, -50%) rotate(${deg}deg)`;
      } else {
        amrMarker.style.transform = `translate(-50%, -50%)`;
      }
    }


    function connectWs() {
      //setWsStatus("WS: connecting‚Ä¶", false);
      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        //setWsStatus("WS: connected", true);
        console.log("[WS] connected");
      };

      socket.onclose = () => {
        console.warn("[WS] disconnected");
       // setWsStatus("WS: disconnected", false);
        if (!reconnectTimer) {
          reconnectTimer = setTimeout(() => {
            reconnectTimer = null;
            connectWs();
          }, 2000);
        }
      };

      socket.onerror = (err) => {
        console.error("[WS] error", err);
      };

      socket.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleWsMessage(msg);
        } catch (e) {
          console.error("Bad WS message:", event.data);
        }
      };
    }

    function sendWs(msg) {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        console.warn("WS not open, skipping send:", msg);
        return;
      }
      socket.send(JSON.stringify(msg));
    }

    function handleWsMessage(msg) {
      switch (msg.type) {
        case "stations_data":
          stationMap = msg.stations || {};
          renderStations();
          break;

        case "odom_station":
          stationOdom.textContent = msg.text || "Waiting for odometry...";
          break;

        case "map_update":
          if (msg.url) {
            stationMapImg.src = msg.url;
          }
          break;

        case "amr_pose": {
          const x = msg.x;
          const y = msg.y;
          const theta = msg.theta;
          if (typeof x === "number" && typeof y === "number") {
            updateMarker(x, y, theta);
          }
          break;
        }

        case "zed_frame": {
          if (msg.jpeg && zedVideoFrame) {
            zedVideoFrame.src = "data:image/jpeg;base64," + msg.jpeg;
          }
          break;
        }

        default:
          console.log("[WS] unhandled message:", msg);
      }
    }

    connectWs();

    // ======== STATION GRID RENDERING ========
    function renderStations() {
      stationsGrid.innerHTML = "";
      const entries = Object.entries(stationMap);
      stationCountLabel.textContent =
        entries.length +
        " station" +
        (entries.length === 1 ? "" : "s") +
        " loaded";

      entries.forEach(([name, data]) => {
        const card = document.createElement("div");
        card.className = "station-card";
        card.dataset.name = name;

        if (name === selectedStationName) {
          card.classList.add("selected");
        }

        const label = document.createElement("div");
        label.className = "station-name";
        label.textContent = name;

        const meta = document.createElement("div");
        meta.className = "station-meta";
        if (Array.isArray(data)) {
          meta.textContent = data.length + " waypoint(s)";
        } else if (data && typeof data === "object") {
          meta.textContent = `(${(data.x ?? data?.position?.x ?? 0)
            .toFixed?.(2) || ""}, ${(data.y ?? data?.position?.y ?? 0)
            .toFixed?.(2) || ""})`;
        } else {
          meta.textContent = "No pose data";
        }

        const btnRow = document.createElement("div");
        btnRow.className = "station-card-buttons";

        const goBtn = document.createElement("button");
        goBtn.className = "station-go";
        goBtn.textContent = "GO";
        goBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          sendWs({ type: "goto_station", name });
        });

        const delBtn = document.createElement("button");
        delBtn.className = "station-del";
        delBtn.textContent = "Del";
        delBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          if (confirm(`Delete station "${name}"?`)) {
            sendWs({ type: "delete_station", name });
            delete stationMap[name];
            if (selectedStationName === name) selectedStationName = null;
            renderStations();
          }
        });

        btnRow.appendChild(goBtn);
        btnRow.appendChild(delBtn);

        card.appendChild(label);
        card.appendChild(meta);
        card.appendChild(btnRow);

        card.addEventListener("click", () => {
          selectedStationName = name;
          renderStations();
        });

        stationsGrid.appendChild(card);
      });
    }

    // ======== SAVE / CANCEL / EMERGENCY ========
    const stationNameInput = document.getElementById("stationNameInput");
    const saveStationBtn = document.getElementById("saveStationBtn");
    const cancelGoalBtn = document.getElementById("cancelGoalBtn");
    const emergencyStopBtn = document.getElementById("emergencyStopBtn");

    saveStationBtn.addEventListener("click", () => {
      const name = stationNameInput.value.trim();
      if (!name) {
        alert("Please enter a station name.");
        return;
      }
      sendWs({ type: "save_station", name });
      stationNameInput.value = "";
    });

    cancelGoalBtn.addEventListener("click", () => {
      sendWs({ type: "cancel_navigation" });
    });

    emergencyStopBtn.addEventListener("click", () => {
      if (confirm("Emergency stop the robot?")) {
        sendWs({ type: "emergency_stop" });
      }
    });

    // ======== DPAD / MOVEMENT ========
    const dpadToggle = document.getElementById("dpadToggle");
    const dpadButtons = {
      up: document.getElementById("dpadUp"),
      down: document.getElementById("dpadDown"),
      left: document.getElementById("dpadLeft"),
      right: document.getElementById("dpadRight"),
      stop: document.getElementById("dpadStop"),
    };

    let dpadEnabled = false;
    let dpadInterval = null;
    let currentVel = { lin: 0, ang: 0 };

    function setDpadEnabled(enabled) {
      dpadEnabled = enabled;
      dpadToggle.classList.toggle("on", enabled);
      dpadToggle.textContent = enabled ? "DPAD: ON" : "DPAD: OFF";

      Object.values(dpadButtons).forEach((btn) => {
        if (btn === dpadButtons.stop) return;
        if (enabled) {
          btn.classList.remove("disabled");
        } else {
          btn.classList.add("disabled");
        }
      });

      if (!enabled) {
        stopDpadMove();
        sendWs({ type: "move", linear: 0.0, angular: 0.0 });
      }
    }

    function startDpadMove(lin, ang) {
      if (!dpadEnabled) return;
      currentVel = { lin, ang };
      if (dpadInterval) clearInterval(dpadInterval);
      sendWs({ type: "move", linear: lin, angular: ang });
      dpadInterval = setInterval(() => {
        sendWs({ type: "move", linear: currentVel.lin, angular: currentVel.ang });
      }, 100);
    }

    function stopDpadMove() {
      currentVel = { lin: 0, ang: 0 };
      if (dpadInterval) {
        clearInterval(dpadInterval);
        dpadInterval = null;
      }
      sendWs({ type: "move", linear: 0.0, angular: 0.0 });
    }

    dpadToggle.addEventListener("click", () => {
      setDpadEnabled(!dpadEnabled);
    });

    function bindDpadButton(btn, lin, ang) {
      btn.addEventListener("mousedown", () => startDpadMove(lin, ang));
      btn.addEventListener(
        "touchstart",
        (e) => {
          e.preventDefault();
          startDpadMove(lin, ang);
        },
        { passive: false }
      );

      ["mouseup", "mouseleave", "touchend", "touchcancel"].forEach((ev) =>
        btn.addEventListener(ev, () => {
          if (!dpadEnabled) return;
          stopDpadMove();
        })
      );
    }

    bindDpadButton(dpadButtons.up, 0.2, 0.0);
    bindDpadButton(dpadButtons.down, -0.2, 0.0);
    bindDpadButton(dpadButtons.left, 0.0, 0.5);
    bindDpadButton(dpadButtons.right, 0.0, -0.5);

    dpadButtons.stop.addEventListener("click", () => {
      stopDpadMove();
      sendWs({ type: "emergency_stop" });
    });

    setDpadEnabled(false); // default OFF

    // ======== 2D POSE (INITIAL POSE) ========
    const poseBtn = document.getElementById("poseBtn");
    let poseMode = false;

    poseBtn.addEventListener("click", () => {
      poseMode = !poseMode;
      poseBtn.classList.toggle("on", poseMode);
      poseBtn.textContent = poseMode ? "2D Pose: ON" : "2D Pose: OFF";
    });

    stationMapImg.addEventListener("click", (e) => {
      if (!poseMode) return;

      const rect = stationMapImg.getBoundingClientRect();
      const px = e.clientX - rect.left;
      const py = e.clientY - rect.top;
      const width = rect.width;
      const height = rect.height;

      sendWs({
        type: "set_initial_pose",
        px,
        py,
        width,
        height,
      });

      poseMode = false;
      poseBtn.classList.remove("on");
      poseBtn.textContent = "2D Pose: OFF";
    });

    // ===============================
    // MAP PAN + ZOOM
    // ===============================
    const mapTransform = document.getElementById("mapTransform");

    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;

    function updateMapTransform() {
      mapTransform.style.transform =
        `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    // Mouse wheel zoom
    mapContainer.addEventListener("wheel", (e) => {
      e.preventDefault();
      const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;

      const rect = mapContainer.getBoundingClientRect();
      const offsetX = e.clientX - rect.left;
      const offsetY = e.clientY - rect.top;

      translateX -= offsetX * (zoomFactor - 1);
      translateY -= offsetY * (zoomFactor - 1);

      scale *= zoomFactor;
      scale = Math.min(Math.max(scale, 0.4), 4);

      updateMapTransform();
    }, { passive: false });

    // Drag pan
    mapContainer.addEventListener("mousedown", (e) => {
      isDragging = true;
      startX = e.clientX - translateX;
      startY = e.clientY - translateY;
      mapContainer.classList.add("dragging");
    });

    window.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      translateX = e.clientX - startX;
      translateY = e.clientY - startY;
      updateMapTransform();
    });

    window.addEventListener("mouseup", () => {
      isDragging = false;
      mapContainer.classList.remove("dragging");
    });

    // ===============================
    // MAP ‚Üî VIDEO SWAP
    // ===============================
    const mapView = document.getElementById("mapView");
    const videoView = document.getElementById("videoView");

    let videoIsMain = false;

    function swapViews() {
      videoIsMain = !videoIsMain;

      if (videoIsMain) {
        mapView.className = "pip-view";
        videoView.className = "main-view";
        document.getElementsByClassName("station-joystick-overlay")[0].style.display = 'none';
      } else {
        mapView.className = "main-view";
        videoView.className = "pip-view";
        document.getElementsByClassName("station-joystick-overlay")[0].style.display = 'flex';
      }
    }

    videoView.addEventListener("click", swapViews);
    mapView.addEventListener("click", () => {
      if (videoIsMain) swapViews();
    });
    /*
    // TEMP: place AMR marker at map center before receiving real pose
    function centerMarkerTemporarily() {
      const containerWidth = mapContainer.clientWidth;
      const containerHeight = mapContainer.clientHeight;

      amrMarker.style.left = `${containerWidth / 2}px`;
      amrMarker.style.top = `${containerHeight / 2}px`;
      amrMarker.style.transform = `translate(-50%, -50%) rotate(0deg)`;
    }

    // call once
    centerMarkerTemporarily();

    // remove after first real AMR pose message:
    let firstPoseReceived = false;
*/
  });
</script>

</body>
</html>
